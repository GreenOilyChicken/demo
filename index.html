<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>二维码扫描器</title>
    <style>
      body {
        font-family: "Microsoft YaHei", sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        text-align: center;
      }
      h1 {
        color: #333;
      }
      .upload-container {
        margin: 30px 0;
        padding: 20px;
        border: 2px dashed #ccc;
        border-radius: 10px;
        cursor: pointer;
      }
      .upload-container:hover {
        border-color: #888;
      }
      #preview {
        max-width: 100%;
        max-height: 300px;
        margin: 20px 0;
        display: none;
      }
      #result {
        margin-top: 20px;
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 5px;
        display: none;
      }
      #fileInput {
        display: none;
      }
      button {
        background-color: #4caf50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px;
      }
      button:hover {
        background-color: #45a049;
      }
      .loading {
        display: none;
        margin: 20px 0;
      }
    </style>
  </head>
  <body>
    <h1>二维码扫描器</h1>
    <p>上传包含二维码的图片，系统会自动识别并跳转到二维码中的链接</p>

    <div class="upload-container" id="uploadContainer">
      <p>点击或拖拽图片到此处</p>
      <input type="file" id="fileInput" accept="image/*" />
    </div>

    <img id="preview" alt="预览图" />

    <div class="loading" id="loading">
      <p>正在扫描二维码...</p>
    </div>

    <div id="result"></div>

    <button id="scanButton" style="display: none">扫描二维码</button>

    <!-- 引入jsQR库 -->
    <script src="./jsQR.min.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const fileInput = document.getElementById("fileInput");
        const uploadContainer = document.getElementById("uploadContainer");
        const preview = document.getElementById("preview");
        const result = document.getElementById("result");
        const scanButton = document.getElementById("scanButton");
        const loading = document.getElementById("loading");

        // 点击上传区域触发文件选择
        uploadContainer.addEventListener("click", function () {
          fileInput.click();
        });

        // 处理拖放事件
        uploadContainer.addEventListener("dragover", function (e) {
          e.preventDefault();
          uploadContainer.style.borderColor = "#45a049";
        });

        uploadContainer.addEventListener("dragleave", function () {
          uploadContainer.style.borderColor = "#ccc";
        });

        uploadContainer.addEventListener("drop", function (e) {
          e.preventDefault();
          uploadContainer.style.borderColor = "#ccc";

          if (e.dataTransfer.files.length) {
            fileInput.files = e.dataTransfer.files;
            handleFileSelect();
          }
        });

        // 处理文件选择
        fileInput.addEventListener("change", handleFileSelect);

        function handleFileSelect() {
          const file = fileInput.files[0];
          if (!file) return;

          // 显示预览
          const reader = new FileReader();
          reader.onload = function (e) {
            preview.src = e.target.result;
            preview.style.display = "block";
            scanButton.style.display = "inline-block";
            result.style.display = "none";
          };
          reader.readAsDataURL(file);
        }

        // 扫描二维码
        scanButton.addEventListener("click", scanQRCode);

        function scanQRCode() {
          loading.style.display = "block";
          result.style.display = "none";

          // 创建一个canvas元素来处理图像
          const canvas = document.createElement("canvas");
          const context = canvas.getContext("2d");

          // 创建图像对象
          const img = new Image();
          img.src = preview.src;

          img.onload = function () {
            // 设置canvas大小与图像一致
            canvas.width = img.width;
            canvas.height = img.height;

            // 在canvas上绘制图像
            context.drawImage(img, 0, 0);

            // 获取图像数据
            const imageData = context.getImageData(
              0,
              0,
              canvas.width,
              canvas.height
            );

            // 使用jsQR库扫描二维码
            const code = jsQR(
              imageData.data,
              imageData.width,
              imageData.height
            );

            loading.style.display = "none";

            if (code) {
              // 找到二维码
              result.innerHTML = `
                            <p>扫描成功！</p>
                            <p>二维码内容: ${code.data}</p>
                            <p>1.5秒后自动跳转...</p>
                        `;
              result.style.display = "block";

              // 3秒后跳转
              setTimeout(function () {
                window.location.href = code.data;
              }, 1500);
            } else {
              // 未找到二维码
              result.innerHTML =
                "<p>未能识别二维码，请尝试上传清晰的二维码图片</p>";
              result.style.display = "block";
            }
          };
        }
      });
    </script>
  </body>
</html>
